<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' lang='en-US'>

<head>
    <title>Simple game</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <style>
        html,
        body {
            overflow-x: hidden;
            overflow-y: auto;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        canvas {
            display: block;
            touch-action: none;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <canvas id="scene"></canvas>
    <script src='frag.min.js'></script>
    
    <script>
        const degToRad = Math.PI / 180;

        class CupModel {
            constructor(game, color) {
                this.mesh = game.engine.Cylinder(8, { color });
                this.model = game.engine.Model()
                    .mesh(this.mesh)
                    .shader(game.shader)
                    .shadeSmooth();
                this.model.getPosition()
                    .scale(10)
                    .rotateX(90 * degToRad);
            }

            dispose() {
                this.model.dispose();
                this.mesh.dispose();
            }
        }

        class Floor {
            constructor(game) {
                this.mesh = game.engine.Plane(1, { color: [0.6, 0.6, 0.6] });
                this.model = game.engine.Model()
                    .mesh(this.mesh)
                    .shader(game.shader)
                    .shadeFlat();
                this.model.getPosition()
                    .scale(100)
                    .rotateX(90 * degToRad)
                    .locationY(-60)
                    .locationZ(150);
                this.object = game.engine.SceneObject(this.model);
                game.scene.addObject(this.object);
            }

            dispose() {
                this.object.dispose();
                this.model.dispose();
                this.mesh.dispose();
            }
        }

        class Cup {
            constructor(game, cupModel, start, end, invSpeed) {
                this.object = game.engine.SceneObject(cupModel.model);
                game.scene.addObject(this.object);

                const position = this.object.getPosition();
                position.location(start);
                
                const animationAction = game.engine.PositionAnimationAction(position, invSpeed)
                    .moveTo(end)
                    .onStop(() => { this.dispose(); });

                this.animation = game.engine.Animation()
                    .perform(animationAction)
                    .start();
            }

            dispose() {
                this.animation.dispose();
                this.object.dispose();
            }
        }

        class CupGenerator {
            constructor(game, cupModels) {
                this.interval = setInterval(() => {
                    if (Math.random() > 0.7) {
                        const model = cupModels[Math.floor(Math.random() * cupModels.length)];
                        const start = [
                            Math.random() > 0.5 ? 100 : -100, 
                            -50,
                            Math.random() * 100 + 100];
                        const end = [-start[0], start[1], start[2]];
                        const invSpeed = Math.random() * 5 + 1;
                        const cup = new Cup(game, model, start, end, invSpeed);
                    }
                }, 1000);
            }

            dispose() {
                this.cancelInterval(this.interval);
            }
        }

        class Game {
            constructor() {
                this.engine = window.frag.Engine().start();
                this.camera = this.engine.PerspectiveCamera().frustrum(35 * degToRad, -100, 100).scaleX(100).moveToZ(-120);
                this.scene = this.engine.Scene().camera(this.camera);
                this.shader = this.engine.Shader().colorsRGB().directionalLightGrey().compile();

                this.engine.mainScene(this.scene);
            }

            dispose() {
                this.shader.dispose();
                this.scene.dispose();
                this.camera.dispose();
                this.engine.dispose();
            }
        }

        const game = new Game();

        const redCupModel = new CupModel(game, [1, 0.4, 0.4]);
        const greenCupModel = new CupModel(game, [0.4, 1, 0.4]);
        const blueCupModel = new CupModel(game, [0.4, 0.4, 1]);

        const floor = new Floor(game);
        const generator = new CupGenerator(game, [redCupModel, greenCupModel, blueCupModel]);

    </script>
</body>