<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' lang='en-US'>
<head>
    <title>Model Loader</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <style>
        html,
        body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #scene {
            width: 100vw;
            height: 100vh;
            touch-action: none;
            display: block;
        }
    </style>
</head>
<body>
    <canvas id='scene'></canvas>
    <script>
        window.frag = {
            init: function(frag){
                frag.debugModelLoader = true;
                frag.debugAnimations = true;
            }
        }
    </script>
    <script src='frag.min.js'></script>
    <script>
        const frag = window.frag;
        const degToRad = Math.PI / 180;

        const camera = frag.PerspectiveCamera()
            .frustrum(35 * degToRad, -100, 100)
            .scaleX(100)
            .moveToZ(-120);

        const scene = frag.Scene()
            .camera(camera);

        frag.mainScene(scene);

        const modelsLoaded = function(assetCatalog) {
            const singleColorMaterial = function(name, rgb) {
                texture = frag.Texture()
                    .dataFormat(frag.gl.RGBA)
                    .fromArrayBuffer(0, new Uint8Array(rgb), 0, 1, 1);
                assetCatalog.getMaterial(name)
                    .setTexture('diffuse', texture);
            }

            singleColorMaterial("Plastic", [220, 220, 255, 255]);
            singleColorMaterial("Metal", [175, 175, 175, 255]);
            singleColorMaterial("Rubber", [120, 90, 90, 255]);
            singleColorMaterial("Transparent", [0, 0, 0, 0]);

            const excavator = frag.SceneObject(assetCatalog.getModel('excavator'));
            excavator.getPosition().scale(5).rotateZ(-15 * degToRad).rotateX(-115 * degToRad);
            scene.addObject(excavator);

            // Start a sequence of actions and repeat forever
            frag.Animation()
            .sequence([
                // Move the excavator from 0 to -100 on the x-axis
                // whilst running the "moving" animation
                frag.ValueAnimationAction()
                    .setDuration(500)
                    .onStart(excavator.animations.moving.start)
                    .onStop(excavator.animations.moving.stop)
                    .onStep((a, r) =>{
                        excavator.getPosition().positionX(r * -100)
                    }),
                // Run the "excavating" animation for a while
                {
                    duration: 2000,
                    start: excavator.animations.excavating.start,
                    stop: excavator.animations.excavating.stop,
                },
                // Move the excavator from -100 to +50 on the x-axis
                // whilst running the "moving" animation
                frag.ValueAnimationAction()
                    .setDuration(750)
                    .onStart(excavator.animations.moving.start)
                    .onStop(excavator.animations.moving.stop)
                    .onStep((a, r) =>{
                        excavator.getPosition().positionX(r * 150 - 100)
                    }),
                // Run the "tipping" animation for a while
                {
                    duration: 500,
                    start: excavator.animations.tipping.start,
                    stop: excavator.animations.tipping.stop,
                },
                // Move the excavator from 50 to 0 on the x-axis
                // whilst running the "moving" animation
                frag.ValueAnimationAction()
                    .setDuration(250)
                    .onStart(excavator.animations.moving.start)
                    .onStop(excavator.animations.moving.stop)
                    .onStep((a, r) =>{
                        excavator.getPosition().positionX((1-r) * 50)
                    }),
            ], true)
            .start();
        }

        shader = frag.Shader()
            .name("Model")
            .diffuseTexture()
            .directionalLightWhite()
            .compile()
            .lightDirection([0.5, -0.1, -0.5]);
        const assetCatalog = frag.AssetCatalog(shader);

        const packageUrl = frag.ModelLoader.littleEndian ? 'assets/models_little.pkg' : 'assets/models_big.pkg';
        frag.ModelLoader.loadModelsFromUrl(packageUrl, assetCatalog, modelsLoaded)

    </script>
</body>
