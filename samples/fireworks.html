<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' lang='en-US'>
<head>
    <title>Fireorks</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <style>
        html,
        body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #scene {
            width: 100vw;
            height: 100vh;
            touch-action: none;
            display: block;
        }
    </style>
</head>
<body>
    <canvas id='scene'></canvas>
    <script src='frag.js'></script>
    <script>
        const frag = window.frag;
        const engine = frag.Engine({
            debugParticles: false,
            transparency: true,
        })
        engine.onStart((engine) => {
            engine.gl.disable(engine.gl.CULL_FACE);
            engine.gl.clearColor(0, 0, 0, 1);
        });
        engine.start();

        const degToRad = Math.PI / 180;

        const camera = frag.FrustumCamera(engine).frustum(50, 50, 500);
        camera.getPosition().locationZ(-150).locationY(25);
        const scene = frag.Scene(engine).camera(camera);
        engine.mainScene(scene);

        const r = function(range, mid) {
            mid = mid || 0;
            return mid + range * (Math.random() - 0.5);
        };

        const randomColor = function() {
            const red = r(0.5, 0.5);
            const green = r(0.5, 0.5);
            const blue = r(0.5, 0.5);
            
            let scale = 1 / red;
            if (green > red) scale = 1 / green;
            if (blue > red && blue > green) scale = 1 / blue;
            return [red * scale, green * scale, blue * scale, 1];
        }

        const rampTexture = engine.Texture()
            .dataFormat(engine.gl.RGBA)
            .fromArrayBuffer(
                0, 
                new Uint8Array([
                    255, 255, 255, 255,
                    255, 255, 255, 255,
                    255, 255, 255, 255,
                    255, 255, 255, 0,
                ]), 
                0, 4, 1);

        const colorTexture = engine.Texture()
            .dataFormat(engine.gl.RGBA)
            .fromArrayBuffer(
                0, 
                new Uint8Array([255, 255, 255, 255]), 
                0, 1, 1);

        const particleSystem = engine.CustomParticleSystem()
            .name('Fireworks')
            .lifetimeGameTickInterval(10)
            .numFrames(1)
            .rampTexture(rampTexture)
            .colorTexture(colorTexture)
            .acceleration([0, -9.8, 0]);
        particleSystem.getPosition().locationXYZ(0, -50, 0);
        scene.addObject(particleSystem);

        const romanCandleEmitter = function(position, color, duration) {
            const emitter = {
                birthParticles: function() {
                    const newParticles = [];
                    for (let i = 0; i < 10; i++) {
                        newParticles.push({
                            lifetime: 6,
                            startSize: 0.5,
                            endSize: 1,
                            position,
                            velocity: [r(2), r(4, 8), r(2)],
                            acceleration: [0, 9.6, 0],
                            orientation: frag.Quaternion.rotationX(90 * degToRad),
                            color,
                        });
                    };
                    return newParticles;
                }
            };
            particleSystem.addEmitter(emitter);
            setTimeout(function(){ particleSystem.removeEmitter(emitter) }, duration * 1000);
        };

        const mineEmitter = function(position, color, size) {
            const emitter = {
                birthParticles: function() {
                    const newParticles = [];
                    for (let i = 0; i < 100; i++) {
                        const velocity = [r(size * 0.2), r(size * 0.4, size), r(size * 0.2)];
                        const acceleration = [velocity[0] * 1.2, -10, velocity[2] * 1.2];
                        newParticles.push({
                            lifetime: 2,
                            startSize: 0.5,
                            position,
                            velocity,
                            acceleration,
                            orientation: frag.Quaternion.rotationX(90 * degToRad),
                            color,
                        });
                    };
                    return newParticles;
                }
            };
            particleSystem.addEmitter(emitter);
            setTimeout(function(){ particleSystem.removeEmitter(emitter) }, 500);
        };

        const mortarEmitter = function(position, color, size) {
            const emitter = {
                birthParticles: function() {
                    const newParticles = [];
                    const latitudeCount = 15;
                    const delta = Math.PI / latitudeCount;
                    for (let i = 0; i <= latitudeCount; i++) {
                        const baseLatitude = Math.PI * (2 * i / latitudeCount - 1);
                        const longitudeCount = i <= latitudeCount / 2 ? (i + 1) * 2 : (latitudeCount - i) * 2 ;
                        for (let j = 0; j <= longitudeCount; j++) {
                            const longitude = r(delta, Math.PI * (2 * j / longitudeCount - 1));
                            const latitude = r(delta, baseLatitude);
                            vx = Math.cos(longitude) * Math.sin(latitude) * size;
                            vy = Math.cos(latitude) * size;
                            vz = Math.sin(longitude) * Math.sin(latitude) * size;
                            newParticles.push({
                                lifetime: 3,
                                startSize: 0.5,
                                position,
                                velocity: [vx, vy, vz],
                                acceleration: [0, 4, 0],
                                orientation: frag.Quaternion.rotationX(90 * degToRad),
                                color,
                            });
                        }
                    };
                    return newParticles;
                }
            };
            particleSystem.addEmitter(emitter);
            setTimeout(function(){ particleSystem.removeEmitter(emitter) }, 150);
        };

        const romanCandles = function() {
            const color = randomColor();
            const durationSec = 20;
            romanCandleEmitter([-80, 0, 0], color, durationSec);
            romanCandleEmitter([0, 0, 0], color, durationSec);
            romanCandleEmitter([80, 0, 0], color, durationSec);
        };

        setInterval(romanCandles, 30000);
        romanCandles();

        const mines = function() {
            const color = randomColor();
            const size = r(25, 50);
            mineEmitter([-40, 0, 0], color, size);
            mineEmitter([40, 0, 0], color, size);
        };

        setInterval(mines, 3000);

        const mortars = function() {
            const count = Math.floor(Math.random() * 3) + 1;
            for (let i = 0; i < count; i++) {
                const position = [r(150), r(30, 110), 0];
                const color = randomColor();
                const size = r(10, 15);
                mortarEmitter(position, color, size);
            }
        };

        setInterval(mortars, 500);
    </script>
</body>
